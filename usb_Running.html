<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Running scans &mdash; xpdAcq 1.1.4 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Initial assessment of your data" href="usb_QuickAssess.html" />
    <link rel="prev" title="Where did all my Sample and Scan objects go?????" href="usb_Where.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            xpdAcq
          </a>
              <div class="version">
                1.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="xpdusers.html">For XPD Users</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="sb_overview.html">Overview of xpd acquisition environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="sb_icollection.html">Overview of the bsui+xpdAcq environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="usb_Beamtime.html">Setting up your Beamtime</a></li>
<li class="toctree-l2"><a class="reference internal" href="usb_Experiment.html">Setting up your XPD acquisition objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="usb_Scan.html">ScanPlan objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="usb_Where.html">Where did all my Sample and Scan objects go?????</a></li>
<li class="toctree-l2"><a class="reference internal" href="usb_Where.html#bt-list-is-your-friends">bt.list() is your friends</a></li>
<li class="toctree-l2"><a class="reference internal" href="usb_Where.html#bt-list-gotchas">bt.list() Gotchas</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Running scans</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#automated-dark-collection">Automated dark collection</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#nice-and-fresh"><strong>Nice and fresh</strong></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#automated-calibration-capture">Automated calibration capture</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#quick-guide-of-calibration-steps-with-pyfai">Quick guide of calibration steps with pyFAI</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#sample-metadata-imported-from-spreadsheet">Sample metadata imported from spreadsheet</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#comma-separated-fields">comma separated fields</a></li>
<li class="toctree-l4"><a class="reference internal" href="#name-fields">name fields</a></li>
<li class="toctree-l4"><a class="reference internal" href="#phase-string">phase string</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dictionary-like-fields">dictionary-like fields</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sample-objects">Sample Objects</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#auto-masking">Auto-masking</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#applied-masks">Applied masks</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#client-server-metadata-schema">client/server metadata schema</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview-with-an-example">Overview with an example</a></li>
<li class="toctree-l4"><a class="reference internal" href="#when-and-how-to-change-exp-hash-uid">when and how to change <code class="docutils literal notranslate"><span class="pre">exp_hash_uid</span></code>?</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#user-defined-folder-tag">User defined folder tag</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="usb_QuickAssess.html">Initial assessment of your data</a></li>
<li class="toctree-l2"><a class="reference internal" href="usb_GlobalOptions.html">xpdAcq Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="db_export.html">Databroker Export</a></li>
<li class="toctree-l2"><a class="reference internal" href="robot.html">Using the Robot</a></li>
<li class="toctree-l2"><a class="reference internal" href="tomo.html">Running Tomography</a></li>
<li class="toctree-l2"><a class="reference internal" href="usb_design.html">An overhaul at v1.1.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="usb_calibration.html">Automated Calibration Injection</a></li>
<li class="toctree-l2"><a class="reference internal" href="usb_darkframe.html">Automatic Dark Frame</a></li>
<li class="toctree-l2"><a class="reference internal" href="usb_mask.html">Mask Data Injection</a></li>
<li class="toctree-l2"><a class="reference internal" href="usb_shutter.html">Automatic Shutter Control</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api_doc.html">API Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="beamlinestaff.html">For Beamline Staff</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">xpdAcq Change Log</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">xpdAcq</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="xpdusers.html">For XPD Users</a></li>
      <li class="breadcrumb-item active">Running scans</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/usb_Running.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="running-scans">
<span id="usb-running"></span><h1>Running scans<a class="headerlink" href="#running-scans" title="Permalink to this heading"></a></h1>
<p>The hard work of the experimental setup is now done.  It involved creating all the
rich metadata container and ScanPlan objects, but with this in the past it makes
it easy and low overhead to run the scans, allowing the experimenter to concentrate
on the science and not the experimental process.</p>
<p>To run scans there are just a few xpdAcq
run engines(functions) that you need.  To run a scan you simply pick the run engine you want
and give it a predefined Sample object and
a predefined ScanPlan object, then hit return and sit back, your scan will be carried out.</p>
<p>The allowed scan types are:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">xrun</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">scanplan</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">xrun</span></code> stands for “XPD run” which is a our main run engine. Full API documentation can be found <a class="reference internal" href="api_doc.html#xrun-api"><span class="std std-ref">CustomizedRunEngine API Documentation</span></a></p>
<p>Here are some examples of a workflow.  Assume a Ni_calibrant sample is loaded on the diffractometer
and the <code class="docutils literal notranslate"><span class="pre">Ni</span></code> Sample object is created as well as all the <code class="docutils literal notranslate"><span class="pre">ScanPlan</span></code> we need.
We will start by doing a scan with <code class="docutils literal notranslate"><span class="pre">Sample</span></code> object <code class="docutils literal notranslate"><span class="pre">Setup</span></code> on our <code class="docutils literal notranslate"><span class="pre">ct_1</span></code> ScanPlan.</p>
<p>Remember, always start with <code class="docutils literal notranslate"><span class="pre">bt.list()</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">bt</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>


<span class="go">ScanPlans:</span>
<span class="go">0: &#39;ct_5&#39;</span>
<span class="go">1: &#39;ct_0.1&#39;</span>
<span class="go">2: &#39;ct_1&#39;</span>
<span class="go">3: &#39;ct_10&#39;</span>
<span class="go">4: &#39;ct_30&#39;</span>
<span class="go">5: &#39;ct_60&#39;</span>
<span class="go">7: &#39;ct_1.5&#39;</span>
<span class="go">8: &#39;ct_100.5&#39;</span>


<span class="go">Samples:</span>
<span class="go">0: Setup</span>
<span class="go">1: Ni</span>
<span class="go">2: kapton_0.9mmOD</span>
<span class="go">3: kapton_1mmOD</span>
<span class="go">4: kapton_0.5mmOD</span>
<span class="go">5: activated_carbon_1</span>
<span class="go">6: activated_carbon_2</span>
<span class="go">7: activated_carbon_3</span>
<span class="gp">...</span>
</pre></div>
</div>
<p>The Sample object I want has list index 0 and the ScanPlan has list index 2.
Let’s try to make sure everything is ok.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">xrun</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="go">INFO: requested exposure time = 1 - &gt; computed exposure time= 1.0</span>
<span class="go">INFO: No calibration file found in config_base. Scan will still keep going on</span>
<span class="go">+-----------+------------+------------+</span>
<span class="go">|   seq_num |       time |  pe1_image |</span>
<span class="go">+-----------+------------+------------+</span>
<span class="go">|         1 | 15:58:47.4 |       5.00 |</span>
<span class="go">+-----------+------------+------------+</span>
<span class="go">generator count [&#39;73dc71&#39;] (scan num: 3)</span>
</pre></div>
</div>
<p>OK, it seems to work, let’s do some testing to see how much intensity we need.
We will do three setup scans with 1.5 seconds and 100.5 seconds exposure
and then compare them.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">xrun</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>  <span class="c1">#1.5 seconds</span>
<span class="go">INFO: requested exposure time = 1.5 - &gt; computed exposure time= 1.5</span>
<span class="go">INFO: No calibration file found in config_base. Scan will still keep going on</span>
<span class="go">+-----------+------------+------------+</span>
<span class="go">|   seq_num |       time |  pe1_image |</span>
<span class="go">+-----------+------------+------------+</span>
<span class="go">|         1 | 16:01:37.3 |       5.00 |</span>
<span class="go">+-----------+------------+------------+</span>
<span class="go">generator count [&#39;728f2f&#39;] (scan num: 5)</span>


<span class="gp">&gt;&gt;&gt; </span><span class="n">setupscan</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>  <span class="c1">#100.5 seconds</span>
<span class="go">INFO: requested exposure time = 100.5 - &gt; computed exposure time= 100.5</span>
<span class="go">INFO: No calibration file found in config_base. Scan will still keep going on</span>
<span class="go">+-----------+------------+------------+</span>
<span class="go">|   seq_num |       time |  pe1_image |</span>
<span class="go">+-----------+------------+------------+</span>
<span class="go">|         1 | 16:02:57.0 |       5.00 |</span>
<span class="go">+-----------+------------+------------+</span>
<span class="go">generator count [&#39;981e70&#39;] (scan num: 6)</span>
</pre></div>
</div>
<p>It seems that the 2 second scans are the best, so let’s do[b] with desired <code class="docutils literal notranslate"><span class="pre">Sample</span></code>
to get the first data-set.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="go">&gt;&gt;&gt;In [13]: xrun(0, 8)</span>
<span class="go">INFO: requested exposure time = 100.5 - &gt; computed exposure time= 100.5</span>
<span class="go">INFO: closing shutter...</span>
<span class="go">INFO: taking dark frame....</span>
<span class="go">INFO: No calibration file found in config_base. Scan will still keep going on</span>
<span class="go">+-----------+------------+------------+</span>
<span class="go">|   seq_num |       time |  pe1_image |</span>
<span class="go">+-----------+------------+------------+</span>
<span class="go">|         1 | 16:04:31.4 |       5.00 |</span>
<span class="go">+-----------+------------+------------+</span>
<span class="go">generator count [&#39;d770c7&#39;] (scan num: 7)</span>
<span class="go">opening shutter...</span>
<span class="go">INFO: No calibration file found in config_base. Scan will still keep going on</span>
<span class="go">+-----------+------------+------------+</span>
<span class="go">|   seq_num |       time |  pe1_image |</span>
<span class="go">+-----------+------------+------------+</span>
<span class="go">|         1 | 16:04:31.5 |       5.00 |</span>
<span class="go">+-----------+------------+------------+</span>
<span class="go">generator count [&#39;0beaaf&#39;] (scan num: 8)</span>
</pre></div>
</div>
<section id="automated-dark-collection">
<span id="auto-dark"></span><h2>Automated dark collection<a class="headerlink" href="#automated-dark-collection" title="Permalink to this heading"></a></h2>
<p>You might have found something weird when you ran the <code class="docutils literal notranslate"><span class="pre">xrun</span></code> command:</p>
<p><em>I only requested one ``xrun`` but the program runs two scans</em></p>
<p>So what happened?</p>
<p>That is a feature called auto-dark subtraction in <code class="docutils literal notranslate"><span class="pre">xpdAcq</span></code>.
When you are running your experiment, <code class="docutils literal notranslate"><span class="pre">xpdAcq</span></code> checks if you have
collected a <strong>fresh and appropriate</strong> dark frame every time it collects a scan.
The definition of <strong>fresh and appropriate</strong> is:</p>
<section id="nice-and-fresh">
<h3><strong>Nice and fresh</strong><a class="headerlink" href="#nice-and-fresh" title="Permalink to this heading"></a></h3>
<blockquote>
<div><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Given a certain period T (``dark window``), there exists a dark frame
with the same **total exposure time** and exactly the same **acquisition time**
as the light frame we are about collect.
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>At <strong>XPD</strong>, the area detector is running in <code class="docutils literal notranslate"><span class="pre">continuous</span> <span class="pre">acquisition</span></code> mode,
which means detector keeps <strong>reading</strong> but only <strong>saves</strong> images when <code class="docutils literal notranslate"><span class="pre">xpdAcq</span></code>
tells it to save, with the desired exposure time.</p>
<p>In short,</p>
<ul class="simple">
<li><p>acquisition time is the collection time for a single frame from area detector.
This can take values between 0.1s to 5s.</p></li>
<li><p>exposure time is the user-defined total acquisition time</p></li>
</ul>
</div>
<p>Automated dark collection is enabled by default and it can be turned off by:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">glbl</span><span class="p">[</span><span class="s1">&#39;auto_dark&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">glbl</span><span class="p">[</span><span class="s1">&#39;shutter_control&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
<p>And the duration of your dark window can be modified by:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">glbl</span><span class="p">[</span><span class="s1">&#39;dk_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span> <span class="c1"># in minutes. default is 3000 minutes</span>
</pre></div>
</div>
<p>Having <code class="docutils literal notranslate"><span class="pre">auto_dark</span></code> set to <code class="docutils literal notranslate"><span class="pre">True</span></code> is strongly recommended as this enables
<code class="docutils literal notranslate"><span class="pre">xpdAcq</span></code> to do automated dark frame subtraction when you pull out data from the
centralized <strong>NSLS-II</strong> server.</p>
</div></blockquote>
</section>
</section>
<section id="automated-calibration-capture">
<span id="auto-calib"></span><h2>Automated calibration capture<a class="headerlink" href="#automated-calibration-capture" title="Permalink to this heading"></a></h2>
<p>Often times, keeping track of which calibration file is associated with a specific scan is very tiring. <code class="docutils literal notranslate"><span class="pre">xpdAcq</span></code> makes this easier or you. Before every
scan is being collected, the program goes to grab the most recent calibration
parameters in <code class="docutils literal notranslate"><span class="pre">xpdUser/config_base</span></code> and load them as part of the
metadata so that you can reference them whenever you want, and make in-situ data
reduction possible!</p>
<section id="quick-guide-of-calibration-steps-with-pyfai">
<span id="calib-manual"></span><h3>Quick guide of calibration steps with pyFAI<a class="headerlink" href="#quick-guide-of-calibration-steps-with-pyfai" title="Permalink to this heading"></a></h3>
<p>1. We assume that you have run <code class="docutils literal notranslate"><span class="pre">run_calibration()</span></code> in the <code class="docutils literal notranslate"><span class="pre">collection</span></code> window
with Ni as your calibrant.  This will automatically expose the Ni, and after a
pause a 2D plot window should pop up on the acquisition computer, looking
something like this:</p>
<blockquote>
<div><a class="reference internal image-reference" href="_images/calib_05.png"><img alt="_images/calib_05.png" class="align-center" src="_images/calib_05.png" style="width: 400px; height: 300px;" /></a>
<p>That is the image we want to perform our  calibration with. Use the <strong>magnify
tool</strong> at the tool bar to zoom in to something that looks like the figure below.
The magnifying tool is enabled by clicking on the button on the toolbar that
looks like a magnifying glass.</p>
<p>Now we will select five rings that PyFAI will use to do the calibration.  To do this
click on the magnifying glass button again to deselect the magnifying tool so the cursor
looks like an arrow.  You will place the tip
of the arrow on the first ring and then <strong>RIGHT click</strong>.  you will see dots going around the
ring you have selected.  Then repeat this for the other four rings you will select.
<cite>For the highest accuracy, We recommend that you select the first, second, third and
6th ring, as shown in the figure.</cite>  The 6th ring is weaker but well separated from its neighbor.</p>
<a class="reference internal image-reference" href="_images/calib_07.png"><img alt="_images/calib_07.png" class="align-center" src="_images/calib_07.png" style="width: 400px; height: 300px;" /></a>
</div></blockquote>
<ol class="arabic" start="2">
<li><p>If you don’t like what you have selected, you can exit out using <code class="docutils literal notranslate"><span class="pre">CTL-C</span></code> and start again
by running <cite>run_calibration()</cite>.  However, if you are happy with your selections accept them by first
making the collection terminal window active by clicking on it, then hitting <code class="docutils literal notranslate"><span class="pre">&lt;enter&gt;</span></code>.</p>
<p>You will now follow the instructions coming from PyFAI.  It asks you to supply the
indices of the rings you have selected.  Because PyFAI was written by a computer
scientist and not a scientist, <strong>the first ring has number 0</strong>, the second has
number 1, the third has number 2 and the 6th has number 5.</p>
<p>If everything has gone well, after supplying all the indices, PyFAI will pop
up a number of plots that can give an expert eye some indication of the quality
of the calibration.  We recommend that you type <code class="docutils literal notranslate"><span class="pre">recalib</span></code> and
then <code class="docutils literal notranslate"><span class="pre">&lt;enter&gt;</span></code> when prompted to
“modify parameters”. This will cause pyFAI to refine the ring selection.
If the dashed lines look as if they are lining up well with
the peaks you have a good calibration.  If not, <cite>CTL-C</cite> and start again.  If yes,
activate the terminal window by clicking on it, hit <code class="docutils literal notranslate"><span class="pre">&lt;enter&gt;</span></code> at the command prompt
then type <code class="docutils literal notranslate"><span class="pre">done</span></code>.</p>
</li>
</ol>
<blockquote>
<div><a class="reference internal image-reference" href="_images/calib_08.png"><img alt="_images/calib_08.png" class="align-center" src="_images/calib_08.png" style="width: 400px; height: 300px;" /></a>
<p>PyFAI can be a bit finicky.  If it hangs, type CTL-C and start over and make
sure you follow the instruction exactly.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You may find more information about calibration process from <a class="reference external" href="http://pyfai.readthedocs.io/en/latest/usage/cookbook/calibrate.html#start-pyfai-calib">pyFAI documentation</a></p>
</div>
</div></blockquote>
<ol class="arabic" start="3">
<li><p>You are done! <code class="docutils literal notranslate"><span class="pre">xpdAcq</span></code> has saved the calibration parameters and will store them will all subsequent scans until you
run another calibration.</p>
<p>To see the current calibration parameters, type <code class="docutils literal notranslate"><span class="pre">show_calib()</span></code>.</p>
<p>You can also find the calibration parameters in a file called
<code class="docutils literal notranslate"><span class="pre">pyFAI_calib.yml</span></code> in <code class="docutils literal notranslate"><span class="pre">.../xpdUser/config_base</span></code></p>
</li>
</ol>
<ol class="arabic simple" start="3">
<li><p>To clean up you can close all the PyFAI windows, including
the 1D integration and 2D regrouping results that pop out (see below).
Return to the <code class="docutils literal notranslate"><span class="pre">Quick</span> <span class="pre">start</span> <span class="pre">tutorial</span></code> by hitting the browser back-arrow.</p></li>
</ol>
<blockquote>
<div><a class="reference internal image-reference" href="_images/calib_09.png"><img alt="_images/calib_09.png" class="align-center" src="_images/calib_09.png" style="width: 400px; height: 300px;" /></a>
</div></blockquote>
</section>
</section>
<section id="sample-metadata-imported-from-spreadsheet">
<span id="import-sample"></span><h2>Sample metadata imported from spreadsheet<a class="headerlink" href="#sample-metadata-imported-from-spreadsheet" title="Permalink to this heading"></a></h2>
<p>In order to facilitate retrospective operation on data, we suggest you to enter
as much information as you can and that is the main philosophy behind <code class="docutils literal notranslate"><span class="pre">xpdAcq</span></code>.</p>
<p>Typing in sample metadata during beamtime is always less efficient and it wastes
your time so a pre-populated excel sheet with all metadata entered beforehand
turns out to be the solution.</p>
<p>In order import sample metadata from spreadsheet, we would need you to have a
pre-filled spreadsheet with name <code class="docutils literal notranslate"><span class="pre">&lt;saf_number&gt;_sample.xls</span></code> sit in <code class="docutils literal notranslate"><span class="pre">xpduser/import</span></code>
directory. Then the import process is simply:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">import_sample_info</span><span class="p">()</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">xpdAcq</span></code> will grab the <code class="docutils literal notranslate"><span class="pre">saf_number</span></code> and <code class="docutils literal notranslate"><span class="pre">bt</span></code> for current beamtime, so make sure you have your spreadsheet named with proper format. For example, if your SAF number is <code class="docutils literal notranslate"><span class="pre">300179</span></code>, then you should have your pre-populated spreadsheet with the name as <code class="docutils literal notranslate"><span class="pre">300179_sample.xls</span></code>, sit inside <code class="docutils literal notranslate"><span class="pre">xpdUser/import</span></code> directory.</p>
<p>To parse the information filled inside your spreadsheet, we have designed
several rules and here are the explanation to each of the rules.</p>
<section id="comma-separated-fields">
<h3>comma separated fields<a class="headerlink" href="#comma-separated-fields" title="Permalink to this heading"></a></h3>
<blockquote>
<div><p>Files with information entities are separated by a comma <code class="docutils literal notranslate"><span class="pre">,</span></code>.</p>
<p>Each separated by <code class="docutils literal notranslate"><span class="pre">,</span></code> will be individually searchable later.</p>
<p>Fields following this parsing rule are:</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">cif</span> <span class="pre">name</span></code></p></td>
<td><p>pointer of potential structures for your sample, if any.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">User</span> <span class="pre">supplied</span> <span class="pre">tags</span></code></p></td>
<td><p>any comment you want to put on for this measurement.</p></td>
</tr>
</tbody>
</table>
<p>Example on <code class="docutils literal notranslate"><span class="pre">User</span> <span class="pre">supplied</span> <span class="pre">tags</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>background, standard --&gt; background, standard
</pre></div>
</div>
<p>And a search on either <code class="docutils literal notranslate"><span class="pre">background</span></code> or``standard`` later on will include
this header.</p>
</div></blockquote>
</section>
<section id="name-fields">
<h3>name fields<a class="headerlink" href="#name-fields" title="Permalink to this heading"></a></h3>
<blockquote>
<div><p>Fields that are used to store a person’s name in <code class="docutils literal notranslate"><span class="pre">first</span> <span class="pre">name</span> <span class="pre">last</span> <span class="pre">name</span></code> format.</p>
<p>Each person’s first and last name will be searchable later on.</p>
<p>Fields following this parsing rule are:</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Collaborators</span></code></p></td>
<td><p>name of your collaborators</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Sample</span> <span class="pre">Maker</span></code></p></td>
<td><p>name of your sample maker</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Lead</span> <span class="pre">Experimenters</span></code></p></td>
<td><p>a person who is going to lead this experiment at beamline</p></td>
</tr>
</tbody>
</table>
<p>Example on name fields:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Maxwell Terban, Benjamin Frandsen ----&gt; Maxwell, Terban, Benjamin, Frandsen
</pre></div>
</div>
<p>A search on either <code class="docutils literal notranslate"><span class="pre">Maxwell</span></code> or <code class="docutils literal notranslate"><span class="pre">Terban</span></code> or <code class="docutils literal notranslate"><span class="pre">Benjamin</span></code> or <code class="docutils literal notranslate"><span class="pre">Frandsen</span></code>
later will include this header.</p>
</div></blockquote>
</section>
<section id="phase-string">
<h3>phase string<a class="headerlink" href="#phase-string" title="Permalink to this heading"></a></h3>
<blockquote>
<div><p>Field used to specify the phase information and chemical composition of your
sample. It’s important to enter this field correctly so that we can have
accelerated data reduction workflow.</p>
<p>Fields follows this parsing rule are:</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Phase</span> <span class="pre">Info</span></code></p></td>
<td><p>field to specify phase information and chemical composition of
your sample</p></td>
</tr>
</tbody>
</table>
<p>phase string will be expect to be enter in a form as
<code class="docutils literal notranslate"><span class="pre">phase_1:</span> <span class="pre">amount,</span> <span class="pre">phase_2:</span> <span class="pre">amount</span></code>.</p>
<p>An example of 0.9% sodium chloride solution will be:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Nacl: 0.09, H20: 0.91
</pre></div>
</div>
<p>This <code class="docutils literal notranslate"><span class="pre">Phase</span> <span class="pre">Info</span></code> will be parsed as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;sample_composition&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;Na&#39;</span><span class="p">:</span><span class="mf">0.09</span><span class="p">,</span> <span class="s1">&#39;Cl&#39;</span><span class="p">:</span><span class="mf">0.09</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span><span class="mf">1.82</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">:</span><span class="mf">0.91</span><span class="p">},</span>
 <span class="s1">&#39;sample_phase&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;NaCl&#39;</span><span class="p">:</span><span class="mf">0.09</span><span class="p">,</span> <span class="s1">&#39;H20&#39;</span><span class="p">:</span><span class="mf">0.91</span><span class="p">},</span>
 <span class="s1">&#39;composition_string&#39;</span><span class="p">:</span> <span class="s1">&#39;Na0.09Cl0.09H1.82O0.91&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">composition_string</span></code> is designed for data reduction software going to be
used. Under <code class="docutils literal notranslate"><span class="pre">xpdAcq</span></code> framework, we will assume
<a class="reference external" href="http://www.diffpy.org/products/pdfgetx3.html">pdfgetx3</a></p>
<p>As before, a search on <code class="docutils literal notranslate"><span class="pre">Na</span></code> or <code class="docutils literal notranslate"><span class="pre">Cl</span></code> or <code class="docutils literal notranslate"><span class="pre">H</span></code> or <code class="docutils literal notranslate"><span class="pre">O</span></code> will include this
header. Also a search on <code class="docutils literal notranslate"><span class="pre">Nacl=0.09</span></code> will include this header as well.</p>
</div></blockquote>
</section>
<section id="dictionary-like-fields">
<h3>dictionary-like fields<a class="headerlink" href="#dictionary-like-fields" title="Permalink to this heading"></a></h3>
<blockquote>
<div><p>Fields that are utilized to store information as <code class="docutils literal notranslate"><span class="pre">key-value</span> <span class="pre">pair</span></code> format.
Standard format of it is <code class="docutils literal notranslate"><span class="pre">key:</span> <span class="pre">value</span></code> and it also follows the comma-separate rule</p>
<p>Fields following this parsing rule are:</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">structural</span> <span class="pre">database</span> <span class="pre">ID</span> <span class="pre">for</span> <span class="pre">phases</span></code></p></td>
<td><p>database name and the ID for
sample phases</p></td>
</tr>
</tbody>
</table>
<p>Example on dictionary-like fields:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ICSD:41120, CCDC:850926 ----&gt; {&#39;ICSD&#39;: &#39;41120&#39;, &#39;CCDC&#39;: &#39;850926&#39;}
</pre></div>
</div>
</div></blockquote>
</section>
<section id="sample-objects">
<h3>Sample Objects<a class="headerlink" href="#sample-objects" title="Permalink to this heading"></a></h3>
<ul>
<li><p><strong>Sample</strong>:</p>
<p>Each row in your spreadsheet will be taken as one valid Sample and metadata
will be parsed based on the contents you type in with above parsing rule.</p>
<p>Generally, after successfully importing sample from spreadsheet, that is what
you would see:</p>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">import_sample_info</span><span class="p">()</span>
<span class="o">***</span> <span class="n">End</span> <span class="n">of</span> <span class="kn">import</span> <span class="nn">Sample</span> <span class="nb">object</span> <span class="o">***</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">bt</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>


<span class="n">ScanPlans</span><span class="p">:</span>




<span class="n">Samples</span><span class="p">:</span>
<span class="mi">0</span><span class="p">:</span> <span class="n">P2S</span>
<span class="mi">1</span><span class="p">:</span> <span class="n">Ni_calibrant</span>
<span class="mi">2</span><span class="p">:</span> <span class="n">activated_carbon_1</span>
<span class="mi">3</span><span class="p">:</span> <span class="n">activated_carbon_2</span>
<span class="mi">4</span><span class="p">:</span> <span class="n">activated_carbon_3</span>
<span class="mi">5</span><span class="p">:</span> <span class="n">activated_carbon_4</span>
<span class="mi">6</span><span class="p">:</span> <span class="n">activated_carbon_5</span>
<span class="mi">7</span><span class="p">:</span> <span class="n">activated_carbon_6</span>
<span class="mi">8</span><span class="p">:</span> <span class="n">FeF3</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="o">-</span><span class="n">bipyridyl</span><span class="p">)</span>
<span class="mi">9</span><span class="p">:</span> <span class="n">Zn_MOF</span>
<span class="o">...</span>


<span class="mi">41</span><span class="p">:</span> <span class="n">ITO_glass_noFilm</span>
<span class="mi">42</span><span class="p">:</span> <span class="n">ITO_glass_1hrHeatUpTo250C_1hrhold250C_airdry</span>
<span class="mi">43</span><span class="p">:</span> <span class="n">ITO_glass_1hrHeatUpTo450C_1hrhold450C_airdry</span>
<span class="mi">44</span><span class="p">:</span> <span class="n">ITO_glass_30minHeatUpTo150C_1</span><span class="mf">.5</span><span class="n">hrhold150C_airdry</span>
<span class="mi">45</span><span class="p">:</span> <span class="n">CeO2_film_calibrant</span>
<span class="mi">46</span><span class="p">:</span> <span class="n">bkg_1mm_OD_capillary</span>
<span class="mi">47</span><span class="p">:</span> <span class="n">bkg_0</span><span class="mf">.9</span><span class="n">mm_OD_capillary</span>
<span class="mi">48</span><span class="p">:</span> <span class="n">bkg_0</span><span class="mf">.5</span><span class="n">mm_OD_capillary</span>
<span class="mi">49</span><span class="p">:</span> <span class="n">bkg_film_on_substrate</span>
</pre></div>
</div>
<ul id="background-obj">
<li><p><strong>Background</strong>:</p>
<p>It is recommended to run a background scan before your sample so it is available for
the automated data reduction steps.  It also allows you to see problems with the
experimental setup, for example, crystalline peaks due to the beam hitting a shutter.</p>
<p>You can associate a Sample as the background for the desired
Sample freely. Linking the background with the sample together also makes the
data-reduction workflow easier.</p>
<p>We specify this grouping by entering background sample name into the
<code class="docutils literal notranslate"><span class="pre">Sample-name</span> <span class="pre">of</span> <span class="pre">sample</span> <span class="pre">background</span></code>  column in the spreadsheet. You can
fill in the <em>Sample Name of your background</em> to whichever sample you want to relate.</p>
<p>For example, in our <a class="reference external" href="https://groups.google.com/forum/?utm_medium=email&amp;utm_source=footer#!topic/xpd-users/_6NSRWg_-l0">spreadsheet template</a> we created pure background
objects kapton_1mmOD, kapton_0.9mmOD and kapton_0.5mmOD
and we link Ni with background kapton_1mmOD by specifying it
at <code class="docutils literal notranslate"><span class="pre">Sample-name</span> <span class="pre">of</span> <span class="pre">sample</span> <span class="pre">background</span></code> column.</p>
<p>A proper linking between <strong>Sample</strong> and <strong>Background</strong> can be seen
from metadata stored inside the <code class="docutils literal notranslate"><span class="pre">Sample</span></code> object. As usual, let’s
interrogate the metadata:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span><span class="p">[]:</span> <span class="n">bt</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">get_md</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>  <span class="c1"># that&#39;s for example, index depends on</span>
                             <span class="c1"># your spreadsheet</span>
<span class="n">out</span><span class="p">[]:</span>
<span class="p">{</span><span class="s1">&#39;bkgd_sample_name&#39;</span><span class="p">:</span> <span class="s1">&#39;kapton_0.9mmOD&#39;</span><span class="p">,</span>
 <span class="s1">&#39;bt_piLast&#39;</span><span class="p">:</span> <span class="s1">&#39;Billinge&#39;</span><span class="p">,</span>
 <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The example above shows your <code class="docutils literal notranslate"><span class="pre">Sample</span></code> with index <code class="docutils literal notranslate"><span class="pre">15</span></code> has been
linked with background <code class="docutils literal notranslate"><span class="pre">kapton_0.9mmOD</span></code>. This can largely speeds up
the automated data-reduction workflow that we will have in the future!</p>
</li>
</ul>
</section>
</section>
<section id="auto-masking">
<span id="auto-mask"></span><h2>Auto-masking<a class="headerlink" href="#auto-masking" title="Permalink to this heading"></a></h2>
<p>Masking can be a tedious process, requiring long hours judging which pixels
are good and which need to be removed. The our automated masking software aims
to alleviate this by applying a set of masks in sequence to return better
quality data.</p>
<p>Masks can be created/used in two ways. The default procedure is a mask is
created for a low scattering sample (usually kapton). Then this mask is reused
for each subsequent image taken with the same detector position. The second
modality is that each image gets is own bespoke mask, potentially derived from
the low scattering mask.</p>
<section id="applied-masks">
<h3>Applied masks<a class="headerlink" href="#applied-masks" title="Permalink to this heading"></a></h3>
<ol class="arabic simple" start="0">
<li><dl class="simple">
<dt>Any mask passed in to the software:</dt><dd><p>If you have any preexisting masks, we will use those as a starting position
to add upon.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Edge mask:</dt><dd><p>A default of 30 pixels from the edge of the detector are masked out.
These pixels are usually faulty as the detector edge has lower than
expected intensity.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Lower threshold mask:</dt><dd><p>A lower threshold mask, which removes all pixels who’s intensities are
lower than a certain value is applied. The default threshold is 0.0</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Upper threshold mask:</dt><dd><p>An upper threshold mask, which removes all pixels who’s intensities are
higher than a certain value is applied. This mask is not applied in the
default settings.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Beamstop holder mask:</dt><dd><p>A beamstop holder mask, which removes pixels underneath a straight
beamstop holder is applied. The beamstop holder is masked by finding the
beamcenter and drawing a pencil like shape from the beamcenter to the edge
of the detector. All the pixels within this polygon are masked. The default
settings are to mask out 30 pixels on either side of the line connecting
the beamcenter and the detector edge</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Binned outlier mask:</dt><dd><p>Lastly a binned outlier mask is applied, removing pixels which are alpha
standard deviations away from the mean intensity as a function of Q. This
mask aims to remove many of the dead/hot pixels and streaks. The default
alpha is 3 standard deviations.</p>
</dd>
</dl>
</li>
</ol>
</section>
</section>
<section id="client-server-metadata-schema">
<span id="client-server-md"></span><h2>client/server metadata schema<a class="headerlink" href="#client-server-metadata-schema" title="Permalink to this heading"></a></h2>
<section id="overview-with-an-example">
<h3>Overview with an example<a class="headerlink" href="#overview-with-an-example" title="Permalink to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">client/server</span></code> schema associate different data with a centralized
mapping, which would allow a more flexible way to link data. Let’s take
calibration as an example. Ideally one will perform a calibration run
before collecting any data so that subsequent runs will be referenced to
the experimental geometry deduced from this calibration run. However,
there might be some time calibration run is executed after data is
collected due to practical situation. Under traditional metadata schema,
the data collected prior to the calibration will not be able to associated
with given geometry in a systematic way; it relies on experimenter to
identify which data should be grouped and this add complexities of
analyzing data after the beamtime.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">client/server</span></code> schema is designed to solve the problem described above.
At the beginning of the beamtime, an unique <code class="docutils literal notranslate"><span class="pre">exp_hash_uid</span></code> is generated.
Every subsequent run will inserted with the metadata <code class="docutils literal notranslate"><span class="pre">client_uid=exp_hash_uid</span></code>
while the calibration run will have <code class="docutils literal notranslate"><span class="pre">server_uid=exp_hash_uid</span></code> in the metadata.
Therefore, by querying scans with the matched client/server uid, production runs
and calibration runs are linked by regardless the order in time. Furthermore,
this <code class="docutils literal notranslate"><span class="pre">client/server</span></code> schema would allow the recalibration if any factor related
to defining experimental geometry, such as wavelength, was known to be in accurate.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">client/server</span></code> logic can be extended to other kinds of mapping as well.
Currently, <code class="docutils literal notranslate"><span class="pre">xpdAcq</span></code> utilizes this logic in associating calibration runs with
production runs.</p>
</section>
<section id="when-and-how-to-change-exp-hash-uid">
<h3>when and how to change <code class="docutils literal notranslate"><span class="pre">exp_hash_uid</span></code>?<a class="headerlink" href="#when-and-how-to-change-exp-hash-uid" title="Permalink to this heading"></a></h3>
<p>It’s strongly suggested to update the <code class="docutils literal notranslate"><span class="pre">exp_hash_uid</span></code> whenever there is
a sensible change to your experimental setup, for example, different detectors,
changes in sample stages, fluctuation of ring current and so on. In this way,
the data that is referenced to the same experiment condition will be more
tightly associated and will make future data analysis easier as direct comparison
is possible.</p>
<p>To update the <code class="docutils literal notranslate"><span class="pre">exp_hash_uid</span></code>, please type following command in the <code class="docutils literal notranslate"><span class="pre">collection</span></code>
terminal of your ipython.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">update_exp_hash_uid</span><span class="p">()</span>

<span class="c1"># example output</span>
<span class="c1">#INFO: experiment hash uid has been updated to 3020835e-9cb3-4c63-9bf4-4834bf5e865f</span>
</pre></div>
</div>
<p>Once <code class="docutils literal notranslate"><span class="pre">exp_hash_uid</span></code> is updated, all subsequent runs will have the
updated <code class="docutils literal notranslate"><span class="pre">client_uid</span></code> metadata and calibration runs will has this new uid
as <code class="docutils literal notranslate"><span class="pre">server_uid</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The idea of <code class="docutils literal notranslate"><span class="pre">hash</span></code> is borrowed from computer science. It means we conceptually
represent all experiment related factors, ranging from the instruments inside
and outside the hutch, synchrotron beam current to ambient temperature, as a
unique identifier, <code class="docutils literal notranslate"><span class="pre">uid</span></code>. Therefore, this identifier could be use for mapping
data that shares common experiment related factors.</p>
</div>
</section>
</section>
<section id="user-defined-folder-tag">
<span id="folder-tag"></span><h2>User defined folder tag<a class="headerlink" href="#user-defined-folder-tag" title="Permalink to this heading"></a></h2>
<p>You can also add metadata to the run by adding key word arguments to the run eg
<code class="docutils literal notranslate"><span class="pre">xrun(0,</span> <span class="pre">8,</span> <span class="pre">my_scan_tag='hello</span> <span class="pre">world')</span></code>. Some pieces of metadata are special,
like <code class="docutils literal notranslate"><span class="pre">folder_tag_list</span></code>. When <code class="docutils literal notranslate"><span class="pre">folder_tag_list</span></code> is added
(eg <code class="docutils literal notranslate"><span class="pre">xrun(0,</span> <span class="pre">8,</span> <span class="pre">folder_tag_list=['status',</span> <span class="pre">'sample_name',</span> <span class="pre">bt_piLast'],</span> <span class="pre">status='after_saxs')</span></code>
the values for those keys will be added to the file path in the same order as
the list
(eg <code class="docutils literal notranslate"><span class="pre">&lt;.../tiff_base/after_saxs/Ni/billinge/mask/file_name&gt;</span></code> for an experiment
on Nickel run by the Billinge group).</p>
<p>Let’s <a class="reference internal" href="usb_QuickAssess.html#usb-quickassess"><span class="std std-ref">take a quick look at our data</span></a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="usb_Where.html" class="btn btn-neutral float-left" title="Where did all my Sample and Scan objects go?????" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="usb_QuickAssess.html" class="btn btn-neutral float-right" title="Initial assessment of your data" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright (c) 2016 trustees of Columbia University in the City of New York.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>